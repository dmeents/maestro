name: 'Deploy Terraform'
description: 'standardized deployment job for terraform'

inputs:
  environment:
    description: 'what environment to deploy to'
    required: true
  envFile:
    description: 'the env file content to use'
    required: true
  terraformConfigPath:
    description: 'the path to the terraform config files'
    required: true
  backendAccessKey:
    description: 'the backend-config access key to use'
    required: true
  backendSecretKey:
    description: 'the backend-config secret key to use'
    required: true
  backendKey:
    description: 'the bucket name of the remote terraform config'
    required: true
  containerImage:
    description: 'the docker image to deploy'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Setup terraform
      uses: hashicorp/setup-terraform@v2

    - name: Set var-file
      shell: bash
      run: |
        echo "${{ inputs.envFile }}" > ${{ inputs.terraformConfigPath }}/env.${{ inputs.environment }}.tfvars
        cat ${{ inputs.terraformConfigPath }}/env.${{ inputs.environment }}.tfvars
        ls -lart ${{ inputs.terraformConfigPath }}

    - name: Init terraform
      shell: bash
      run: |
        terraform -chdir=${{ inputs.terraformConfigPath }} init \
          -input=false \
          -no-color \
          -backend-config='access_key=${{ inputs.backendAccessKey }}' \
          -backend-config='secret_key=${{ inputs.backendSecretKey }}' \
          -backend-config='key=${{ inputs.backendKey }}'

    - name: Run terraform plan
      shell: bash
      run: |
        terraform -chdir=${{ inputs.terraformConfigPath }} plan \
          -input=false \
          -compact-warnings \
          -var 'container_image=${{ inputs.containerImage }}' \
          -var-file=env.${{ inputs.environment }}.tfvars
